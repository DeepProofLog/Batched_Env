
======================================================================
EVALUATION PROFILING REPORT
======================================================================
Date: 2025-12-15 15:01:16
Device: cuda
Batch size: 256
Steps: 20
Compile mode: reduce-overhead

Setting up components...
Queries loaded - Test: 5626
Using 256 queries

======================================================================
COMPONENT PROFILING (Eager Mode)
======================================================================
Batch size: 256
Steps: 20

Component breakdown:
  init_state_from_queries                  56.24 ms
  _compute_derived_functional              37.28 ms    ( 99.7%)
  get_derived_states_compiled (raw)        33.39 ms    ( 89.3%)
  step_functional (total)                  37.40 ms
  Step overhead (non-unification)           0.11 ms    (  0.3%)

Tensor shapes (batch=256):
  derived_states: torch.Size([256, 120, 6, 3])
  M_max (padding_states): 26
  K_max (padding_atoms): 120

======================================================================
COMPILED STEP PROFILING (mode='reduce-overhead')
======================================================================
Batch size: 256
Compile mode: reduce-overhead

Compiling with mode='reduce-overhead'...
Compilation time: 0.13 s

Warmup (5 steps)...
  Warmup step times: 4259.8, 2323.7, 53.7, 23.9, 23.9 ms

Timing 20 steps with done tracking...
  Early exit at step 19 (all 256 queries done)

PERFORMANCE SUMMARY:
  Compilation time                        129.41 ms
  Total eval time                         454.39 ms
  Mean step time (20 steps)                22.72 ms
  Min step time                            21.60 ms
  Max step time                            40.87 ms
  Time per query (20 steps)                 1.77 ms

PER-STEP BREAKDOWN:
  Step   Done       Time (ms)    Active     Wasted %  
  ------------------------------------------------
  0          0/256       40.87      256        0.0%
  1        142/256       22.19      256        0.0%
  2        142/256       21.88      114       55.5%
  3        142/256       21.67      114       55.5%
  4        142/256       21.68      114       55.5%
  5        151/256       21.68      114       55.5%
  6        151/256       21.81      105       59.0%
  7        203/256       21.83      105       59.0%
  8        209/256       21.77       53       79.3%
  9        241/256       21.63       47       81.6%
  10       243/256       21.65       15       94.1%
  11       250/256       21.75       13       94.9%
  12       250/256       21.73        6       97.7%
  13       251/256       21.63        6       97.7%
  14       251/256       21.81        5       98.0%
  15       254/256       21.96        5       98.0%
  16       254/256       21.77        2       99.2%
  17       254/256       21.67        2       99.2%
  18       254/256       21.60        2       99.2%
  19       256/256       21.81        2       99.2%

EFFICIENCY ANALYSIS:
  Average active query ratio: 26.1%
  Theoretical speedup if skipping done: 3.83x
  Estimated wasted time (done queries): 335.8 ms (73.9%)

======================================================================
BOTTLENECK ANALYSIS
======================================================================

BOTTLENECK RANKING:
  Component                                Time (ms)    Notes
  --------------------------------------------------------------------------------
  Compilation (one-time)                       129.41   One-time cost, amortized over many evals
  Unification (per step)                        37.28   Total: 745.6 ms for 20 steps
  Step overhead (non-unification)              -14.56   Policy forward, state updates, etc.
  Total per step                                22.72   = unification + overhead

KEY INSIGHTS:
  1. Unification is the dominant per-step cost
  2. All B queries processed every step (no early exit per query)
  3. With CUDA graphs (reduce-overhead), batch size must stay fixed
  4. Optimal batch size ~512 (larger causes memory bandwidth issues)

RECOMMENDATIONS:
  1. [HIGH] Implement per-query early exit (skip done queries in unification)
  2. [MED] Profile unification kernel for optimization opportunities
  3. [LOW] Consider reducing max_depth if most proofs finish early
  4. [LOW] Pre-compute and cache common unification patterns

======================================================================
COMPARISON: default mode
======================================================================

======================================================================
COMPILED STEP PROFILING (mode='default')
======================================================================
Batch size: 256
Compile mode: default

Compiling with mode='default'...
Compilation time: 0.00 s

Warmup (5 steps)...
  Warmup step times: 2172.4, 2348.7, 22.4, 22.3, 22.0 ms

Timing 20 steps with done tracking...
  Early exit at step 19 (all 256 queries done)

PERFORMANCE SUMMARY:
  Compilation time                          0.47 ms
  Total eval time                         409.97 ms
  Mean step time (20 steps)                20.50 ms
  Min step time                            19.89 ms
  Max step time                            22.42 ms
  Time per query (20 steps)                 1.60 ms

PER-STEP BREAKDOWN:
  Step   Done       Time (ms)    Active     Wasted %  
  ------------------------------------------------
  0          0/256       22.31      256        0.0%
  1        142/256       22.42      256        0.0%
  2        142/256       22.16      114       55.5%
  3        142/256       21.85      114       55.5%
  4        142/256       20.34      114       55.5%
  5        151/256       20.07      114       55.5%
  6        151/256       20.06      105       59.0%
  7        203/256       19.92      105       59.0%
  8        206/256       20.03       53       79.3%
  9        240/256       20.04       50       80.5%
  10       243/256       19.89       16       93.8%
  11       251/256       19.91       13       94.9%
  12       251/256       20.03        5       98.0%
  13       251/256       20.27        5       98.0%
  14       251/256       20.08        5       98.0%
  15       254/256       20.00        5       98.0%
  16       254/256       20.13        2       99.2%
  17       254/256       20.18        2       99.2%
  18       254/256       20.39        2       99.2%
  19       256/256       19.89        2       99.2%

EFFICIENCY ANALYSIS:
  Average active query ratio: 26.1%
  Theoretical speedup if skipping done: 3.83x
  Estimated wasted time (done queries): 302.8 ms (73.9%)

======================================================================
MODE COMPARISON SUMMARY
======================================================================

  Mode                 Compile (s)     Eval (ms)       Mean Step (ms) 
  -----------------------------------------------------------------
  reduce-overhead      0.13            454.39          22.72          
  default              0.00            409.97          20.50          

  reduce-overhead speedup vs default: 0.90x

  Per-candidate timing (batch_size=256):
    reduce-overhead: 1.775 ms/candidate
    default:         1.601 ms/candidate
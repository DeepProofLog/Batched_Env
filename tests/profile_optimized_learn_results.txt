Profile Optimized Learn Results
Date: 2025-12-16 15:50:49
Device: cuda
Dataset: countries_s3

Configuration:
  Total timesteps (profiled): 1
  Batch size env: 128
  N steps per rollout: 128
  N epochs: 5
  Minibatch size: 1024
  Compile mode: reduce-overhead
  Fullgraph: True


Setting up components...
Queries loaded - Train: 111/111, Valid: 24, Test: 24
Using Automatic Mixed Precision (AMP) with dtype: torch.bfloat16
Compiling policy network and loss module for training...
Initialization time: 2.41s

Running warmup (compilation + first rollout)...
Compiling step_with_policy (mode='reduce-overhead', fullgraph=True)...
Warmup: Running learn() iteration to compile all graphs...

Collecting rollouts
Collecting rollouts: 0/128 steps
Collecting rollouts: 25/128 steps
Collecting rollouts: 50/128 steps
Collecting rollouts: 75/128 steps
Collecting rollouts: 100/128 steps
Collecting rollouts: 125/128 steps
Rollout collected in 7.05s. FPS: 2323.34


Training
Epoch 1/5
Epoch 2/5
Epoch 3/5
Epoch 4/5
Epoch 5/5
Training completed in 1.94s
Iteration 1, timesteps: 16384/128.  total loss: 0.1943, policy_loss: -0.0023, value_loss: 0.1966, entropy_loss: 0.0112, approx_kl: 0.3748, clip_fraction: 0.0420, explained_var: -6.0447

Warmup time: 9.05s

Profiling training for 1 timesteps...

Collecting rollouts
Collecting rollouts: 0/128 steps
Collecting rollouts: 25/128 steps
Collecting rollouts: 50/128 steps
Collecting rollouts: 75/128 steps
Collecting rollouts: 100/128 steps
Collecting rollouts: 125/128 steps
Rollout collected in 1.84s. FPS: 8928.44


Training
Epoch 1/5
Epoch 2/5
Epoch 3/5
Epoch 4/5
Epoch 5/5
Training completed in 1.79s
Iteration 1, timesteps: 32768/16385.  total loss: 0.0147, policy_loss: -0.0021, value_loss: 0.0168, entropy_loss: 0.0023, approx_kl: 0.3126, clip_fraction: 0.0242, explained_var: 0.6235


================================================================================
TIMING SUMMARY
================================================================================
Init time:         2.4102s
Warmup time:       9.0451s
Runtime:           3.6461s
Total time:        12.6913s
Steps/second:      4493.5
Total timesteps:   32768 (Warmup: 16384, Profiled: 16384)

Last training metrics:
  policy_loss: -0.0021
  value_loss: 0.0168
  entropy: 0.0023
  clip_fraction: 0.0242
  approx_kl: 0.3126
  explained_var: 0.6235

================================================================================
PROFILING RESULTS - Top by Cumulative Time
================================================================================
         618080 function calls (543154 primitive calls) in 2.451 seconds

   Ordered by: cumulative time
   List reduced from 712 to 40 due to restriction <40>

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
       80    0.000    0.000    1.299    0.016 __init__.py:243(backward)
       80    0.001    0.000    1.299    0.016 graph.py:832(_engine_run_backward)
       80    1.143    0.014    1.295    0.016 {method 'run_backward' of 'torch._C._EngineBase' objects}
16543/338    0.018    0.000    0.467    0.001 module.py:1771(_wrapped_call_impl)
16543/338    0.024    0.000    0.466    0.001 module.py:1779(_call_impl)
      129    0.000    0.000    0.404    0.003 model.py:730(predict_values)
      944    0.006    0.000    0.352    0.000 eval_frame.py:1039(_fn)
      129    0.001    0.000    0.330    0.003 model.py:432(forward)
      129    0.009    0.000    0.329    0.003 model.py:339(forward_joint)
  368/288    0.004    0.000    0.279    0.001 utils.py:119(call_func_at_runtime_with_args)
      258    0.001    0.000    0.261    0.001 model.py:270(_encode_with_shared_body)
      258    0.033    0.000    0.259    0.001 model.py:138(forward)
     2709    0.014    0.000    0.258    0.000 container.py:245(forward)
      288    0.003    0.000    0.254    0.001 output_code.py:590(__call__)
      288    0.001    0.000    0.223    0.001 compile_fx.py:1767(run)
      288    0.000    0.000    0.222    0.001 cudagraph_trees.py:378(deferred_cudagraphify)
      288    0.001    0.000    0.221    0.001 utils.py:3013(run)
  494/288    0.003    0.000    0.218    0.001 cudagraph_trees.py:2008(run)
  494/288    0.001    0.000    0.213    0.001 cudagraph_trees.py:2073(_run)
      287    0.002    0.000    0.186    0.001 cudagraph_trees.py:2241(execute_node)
        6    0.180    0.030    0.180    0.030 {method 'item' of 'torch._C.TensorBase' objects}
      208    0.001    0.000    0.161    0.001 aot_autograd.py:1126(forward)
      287    0.002    0.000    0.159    0.001 cudagraph_trees.py:1105(run)
      208    0.001    0.000    0.154    0.001 runtime_wrappers.py:310(runtime_wrapper)
       80    0.017    0.000    0.151    0.002 function.py:300(apply)
      287    0.001    0.000    0.145    0.001 cudagraph_trees.py:1219(run_graph)
       80    0.000    0.000    0.135    0.002 runtime_wrappers.py:2239(backward)
       80    0.002    0.000    0.134    0.002 runtime_wrappers.py:2288(impl_fn)
      208    0.001    0.000    0.132    0.001 runtime_wrappers.py:512(wrapper)
       80    0.000    0.000    0.127    0.002 runtime_wrappers.py:2330(_backward_impl)
     3479    0.124    0.000    0.124    0.000 {method 'clone' of 'torch._C.TensorBase' objects}
       80    0.001    0.000    0.120    0.001 c5mbvhukgnltvrt7gah5axgewli4zb5gj7aseilmqeds25ukmfb6.py:6020(call)
      288    0.097    0.000    0.110    0.000 graphs.py:139(replay)
      127    0.014    0.000    0.105    0.001 env_optimized.py:894(_step_with_policy_impl)
     3096    0.003    0.000    0.099    0.000 linear.py:130(forward)
     3096    0.094    0.000    0.094    0.000 {built-in method torch._C._nn.linear}
      129    0.000    0.000    0.072    0.001 model.py:584(extract_features)
      129    0.002    0.000    0.071    0.001 model.py:66(forward)
      127    0.001    0.000    0.071    0.001 cw5wxim6hn6gwayeaqvmxyhverw5qmlr4vsi6rygz6e5bav647pf.py:12134(call)
   240/80    0.003    0.000    0.067    0.001 clip_grad.py:41(_no_grad_wrapper)




================================================================================
PROFILING RESULTS - Top by Total Time
================================================================================
         618080 function calls (543154 primitive calls) in 2.451 seconds

   Ordered by: internal time
   List reduced from 712 to 40 due to restriction <40>

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
       80    1.143    0.014    1.295    0.016 {method 'run_backward' of 'torch._C._EngineBase' objects}
        6    0.180    0.030    0.180    0.030 {method 'item' of 'torch._C.TensorBase' objects}
     3479    0.124    0.000    0.124    0.000 {method 'clone' of 'torch._C.TensorBase' objects}
      288    0.097    0.000    0.110    0.000 graphs.py:139(replay)
     3096    0.094    0.000    0.094    0.000 {built-in method torch._C._nn.linear}
     2322    0.043    0.000    0.043    0.000 {built-in method torch.layer_norm}
  289/288    0.041    0.000    0.041    0.000 {built-in method torch._foreach_copy_}
     2709    0.039    0.000    0.039    0.000 {built-in method torch.relu}
      258    0.033    0.000    0.259    0.001 model.py:138(forward)
16543/338    0.024    0.000    0.466    0.001 module.py:1779(_call_impl)
      516    0.021    0.000    0.021    0.000 {built-in method torch.embedding}
16543/338    0.018    0.000    0.467    0.001 module.py:1771(_wrapped_call_impl)
       80    0.017    0.000    0.151    0.002 function.py:300(apply)
     2709    0.014    0.000    0.258    0.000 container.py:245(forward)
      127    0.014    0.000    0.105    0.001 env_optimized.py:894(_step_with_policy_impl)
      128    0.013    0.000    0.015    0.000 rollout_optimized.py:204(add)
      258    0.013    0.000    0.016    0.000 embeddings.py:771(forward)
        1    0.012    0.012    0.014    0.014 rollout_optimized.py:244(compute_returns_and_advantage)
      117    0.011    0.000    0.011    0.000 {built-in method torch.where}
44480/5840    0.010    0.000    0.012    0.000 module.py:2823(named_modules)
       80    0.010    0.000    0.010    0.000 {built-in method torch._foreach_norm}
     5047    0.010    0.000    0.010    0.000 {method 'to' of 'torch._C.TensorBase' objects}
      640    0.009    0.000    0.009    0.000 {built-in method torch.index_select}
    16687    0.009    0.000    0.009    0.000 {built-in method torch._C._get_tracing_state}
      192    0.009    0.000    0.009    0.000 {method 'cpu' of 'torch._C.TensorBase' objects}
      129    0.009    0.000    0.329    0.003 model.py:339(forward_joint)
      449    0.008    0.000    0.008    0.000 {built-in method torch._ops.profiler._record_function_enter_new}
      760    0.008    0.000    0.008    0.000 {method 'copy_' of 'torch._C.TensorBase' objects}
     2322    0.008    0.000    0.014    0.000 functional.py:1394(dropout)
      343    0.008    0.000    0.008    0.000 {method 'mean' of 'torch._C.TensorBase' objects}
      287    0.007    0.000    0.010    0.000 cudagraph_trees.py:1126(reconstruct_outputs)
       80    0.007    0.000    0.012    0.000 adam.py:138(_init_group)
    57593    0.007    0.000    0.007    0.000 {method 'append' of 'list' objects}
       80    0.007    0.000    0.061    0.001 ppo_optimized.py:155(forward)
     8518    0.007    0.000    0.012    0.000 cudagraph_trees.py:534(expired)
    15867    0.006    0.000    0.006    0.000 module.py:1951(__getattr__)
      944    0.006    0.000    0.352    0.000 eval_frame.py:1039(_fn)
60124/59832    0.006    0.000    0.006    0.000 {built-in method builtins.isinstance}
      201    0.006    0.000    0.006    0.000 {built-in method torch.zeros}
      129    0.006    0.000    0.006    0.000 {built-in method torch.matmul}




Results saved to tests/profile_optimized_learn_results.txt
